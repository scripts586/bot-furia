import discord
from discord import app_commands
from discord.ext import commands
import os
from flask import Flask
from threading import Thread
import asyncio
import random
import json
import datetime

# --- BANCO DE DADOS (JSON) ---
def carregar_dados(arquivo):
    try:
        with open(arquivo, 'r') as f: return json.load(f)
    except FileNotFoundError: return {}

def salvar_dados(arquivo, dados):
    with open(arquivo, 'w') as f: json.dump(dados, f, indent=4)

def carregar_blacklist(): return carregar_dados('blacklist.json')
def salvar_blacklist(dados): salvar_dados('blacklist.json', dados)

# --- KEEP ALIVE (PARA RENDER/UPTIME) ---
app = Flask('')
@app.route('/')
def home(): return "Bot Furia Online!"
def run(): app.run(host='0.0.0.0', port=8080)
def keep_alive():
    t = Thread(target=run)
    t.start()

# --- CONFIGURAÃ‡ÃƒO DO BOT ---
intents = discord.Intents.all()
bot = commands.Bot(command_prefix='!', intents=intents)

mediadores_dados = {} 
fila_mediadores = [] 
dados_filas_jogadores = {} 
salas_ativas = {} 
valores_lista = ["100", "50", "40", "30", "20", "10", "5", "4", "3", "2", "1"]

# --- VIEW: FINALIZAÃ‡ÃƒO DE APOSTA (/WIN) ---
class ViewFinalizarWin(discord.ui.View):
    def __init__(self, p1, p2, valor_aposta):
        super().__init__(timeout=None)
        self.p1, self.p2 = p1, p2
        self.valor = valor_aposta
        self.ganhador = None
        self.perdedor = None

    @discord.ui.select(placeholder="ğŸ¥‡ Selecionar o Vencedor da Partida...")
    async def select_ganhador(self, interaction: discord.Interaction, select: discord.ui.Select):
        self.ganhador = interaction.guild.get_member(int(select.values[0]))
        await interaction.response.send_message(f"âœ… Ganhador definido: **{self.ganhador.display_name}**", ephemeral=True)

    @discord.ui.select(placeholder="ğŸ’€ Selecionar o Perdedor da Partida...")
    async def select_perdedor(self, interaction: discord.Interaction, select: discord.ui.Select):
        self.perdedor = interaction.guild.get_member(int(select.values[0]))
        await interaction.response.send_message(f"âœ… Perdedor definido: **{self.perdedor.display_name}**", ephemeral=True)

    @discord.ui.button(label="FINALIZAR E REGISTRAR", style=discord.ButtonStyle.danger, emoji="ğŸ”’")
    async def finalizar(self, interaction: discord.Interaction, button: discord.ui.Button):
        if not self.ganhador or not self.perdedor:
            return await interaction.response.send_message("âŒ Erro: Selecione ambos os jogadores!", ephemeral=True)
        
        await interaction.response.defer()
        stats = carregar_dados('stats.json')
        for uid in [str(self.ganhador.id), str(self.perdedor.id)]:
            if uid not in stats: stats[uid] = {"vitorias": 0, "derrotas": 0, "streak": 0}
        
        stats[str(self.ganhador.id)]["vitorias"] += 1
        stats[str(self.ganhador.id)]["streak"] += 1
        stats[str(self.perdedor.id)]["derrotas"] += 1
        stats[str(self.perdedor.id)]["streak"] = 0
        salvar_dados('stats.json', stats)

        canal_res = discord.utils.get(interaction.guild.text_channels, name="seus-apostados-aquiğŸ“Œ")
        embed_res = discord.Embed(title="ğŸ RESULTADO REGISTRADO", color=0x2ECC71, timestamp=datetime.datetime.now())
        embed_res.add_field(name="ğŸ‘‘ Vencedor", value=f"{self.ganhador.mention}\n`Streak: {stats[str(self.ganhador.id)]['streak']}ğŸ”¥`", inline=True)
        embed_res.add_field(name="ğŸ’€ Perdedor", value=f"{self.perdedor.mention}\n`Derrota`", inline=True)
        embed_res.add_field(name="ğŸ’° Valor", value=f"```R$ {self.valor},00```", inline=False)
        embed_res.set_footer(text="FÃºria Apostas | Sistema Automatizado")
        
        if canal_res: await canal_res.send(embed=embed_res)

        chave_voz = f"{self.p1.id}-{self.p2.id}"
        sala_id = salas_ativas.pop(chave_voz, salas_ativas.pop(f"{self.p2.id}-{self.p1.id}", None))
        if sala_id:
            cv = interaction.guild.get_channel(sala_id)
            if cv: await cv.delete()

        await interaction.followup.send("ğŸš¨ **Aposta encerrada com sucesso!** O tÃ³pico serÃ¡ deletado em 5s.")
        await asyncio.sleep(5)
        await interaction.channel.delete()

# --- MODAL: CADASTRO PIX ---
class ModalCadastroPix(discord.ui.Modal, title='ğŸ“„ Cadastro de Mediador'):
    nome = discord.ui.TextInput(label='Nome Completo', placeholder='Seu nome real...')
    banco = discord.ui.TextInput(label='Banco', placeholder='Ex: Nubank, Inter...')
    chave = discord.ui.TextInput(label='Chave Pix', placeholder='Sua chave para receber...')
    async def on_submit(self, interaction: discord.Interaction):
        mediadores_dados[interaction.user.id] = {"nome": self.nome.value, "banco": self.banco.value, "chave": self.chave.value}
        await interaction.response.send_message(f"âœ… Seus dados de pagamento foram salvos!", ephemeral=True)

# --- VIEW: CONFIRMAÃ‡ÃƒO NO TÃ“PICO ---
class ViewConfirmacaoAposta(discord.ui.View):
    def __init__(self, p1, p2, valor):
        super().__init__(timeout=None)
        self.p1, self.p2, self.valor = p1, p2, valor
        self.confirmado = {p1.id: False, p2.id: False}

    @discord.ui.button(label="ACEITAR DESAFIO", style=discord.ButtonStyle.success, emoji="âš”ï¸")
    async def confirmar(self, interaction, button):
        if interaction.user.id not in [self.p1.id, self.p2.id]: return
        self.confirmado[interaction.user.id] = True
        await interaction.response.send_message(f"âœ… {interaction.user.mention} confirmou!", ephemeral=False)
        
        if all(self.confirmado.values()):
            mid = random.choice(fila_mediadores) if fila_mediadores else None
            muser = interaction.guild.get_member(mid) if mid else None
            dpix = mediadores_dados.get(mid) if mid else None
            
            cat = discord.utils.get(interaction.guild.categories, name="SALAS DE APOSTA") or await interaction.guild.create_category("SALAS DE APOSTA")
            cv = await interaction.guild.create_voice_channel(name=f"ğŸ™ï¸ X1 R${self.valor}", category=cat)
            salas_ativas[f"{self.p1.id}-{self.p2.id}"] = cv.id
            
            embed = discord.Embed(title="ğŸ¦ PAGAMENTO LIBERADO", color=0xF1C40F)
            embed.description = "Realizem o pagamento para o mediador abaixo para iniciar."
            if muser: embed.add_field(name="ğŸ‘® Mediador", value=muser.mention, inline=False)
            if dpix: embed.add_field(name="ğŸ”‘ Pix (Copia e Cola)", value=f"```{dpix['chave']}```", inline=False)
            embed.add_field(name="ğŸ”Š Canal de Voz", value=cv.mention, inline=False)
            await interaction.channel.send(embed=embed)

# --- VIEW: CENTRAL DE MEDIADORES ---
class ViewCentral(discord.ui.View):
    def __init__(self): super().__init__(timeout=None)
    @discord.ui.button(label="Ficar Online", style=discord.ButtonStyle.success, emoji="âœ…")
    async def entrar_med(self, interaction, button):
        if interaction.user.id not in mediadores_dados: return await interaction.response.send_message("âŒ Cadastre seu Pix primeiro!", ephemeral=True)
        if interaction.user.id not in fila_mediadores: fila_mediadores.append(interaction.user.id); await interaction.response.send_message("VocÃª estÃ¡ ONLINE!", ephemeral=True)
    @discord.ui.button(label="Cadastrar Pix", style=discord.ButtonStyle.secondary, emoji="ğŸ’¸")
    async def cad_pix(self, interaction, button): await interaction.response.send_modal(ModalCadastroPix())

# --- VIEW: FILA DE JOGADORES ---
class ViewFilaJogadores(discord.ui.View):
    def __init__(self, valor):
        super().__init__(timeout=None)
        self.valor = valor
    @discord.ui.button(label="Entrar na Fila", style=discord.ButtonStyle.secondary, emoji="âœ…")
    async def entrar(self, interaction, button):
        bl = carregar_blacklist()
        if str(interaction.user.id) in bl: return await interaction.response.send_message("ğŸš« VocÃª estÃ¡ na Blacklist!", ephemeral=True)
        chave = (interaction.channel.id, self.valor)
        if chave not in dados_filas_jogadores: dados_filas_jogadores[chave] = []
        if interaction.user not in dados_filas_jogadores[chave]:
            dados_filas_jogadores[chave].append(interaction.user)
            await interaction.response.send_message(f"âœ… VocÃª entrou na fila de R$ {self.valor}!", ephemeral=True)
            if len(dados_filas_jogadores[chave]) >= 2:
                p1, p2 = dados_filas_jogadores[chave].pop(0), dados_filas_jogadores[chave].pop(0)
                canal_dest = discord.utils.get(interaction.guild.text_channels, name="seus-apostados-aquiğŸ“Œ")
                if canal_dest:
                    msg = await canal_dest.send(f"âš ï¸ **PARTIDA ENCONTRADA:** {p1.mention} vs {p2.mention}")
                    thread = await msg.create_thread(name=f"ğŸ’¸ R${self.valor} | {p1.display_name} vs {p2.display_name}")
                    await thread.send(content=f"{p1.mention} {p2.mention}", view=ViewConfirmacaoAposta(p1, p2, self.valor))

# --- COMANDOS SLASH (/) ---

@bot.tree.command(name="p", description="Ver o seu perfil de apostador")
async def p(interaction: discord.Interaction, membro: discord.Member = None):
    membro = membro or interaction.user
    stats = carregar_dados('stats.json')
    d = stats.get(str(membro.id), {"vitorias": 0, "derrotas": 0, "streak": 0})
    total = d['vitorias'] + d['derrotas']
    wr = (d['vitorias'] / total * 100) if total > 0 else 0
    embed = discord.Embed(title=f"ğŸ“Š STATUS DE ATLETA", color=0x3498DB)
    embed.set_author(name=membro.display_name, icon_url=membro.display_avatar.url)
    embed.add_field(name="ğŸ† VitÃ³rias", value=f"**{d['vitorias']}**", inline=True)
    embed.add_field(name="ğŸ’€ Derrotas", value=f"**{d['derrotas']}**", inline=True)
    embed.add_field(name="ğŸ”¥ Streak", value=f"**{d['streak']}**", inline=True)
    embed.add_field(name="ğŸ“ˆ Winrate", value=f"**{wr:.1f}%**", inline=True)
    await interaction.response.send_message(embed=embed)

@bot.tree.command(name="ranking", description="Top 10 do Servidor")
async def ranking(interaction: discord.Interaction):
    stats = carregar_dados('stats.json')
    if not stats: return await interaction.response.send_message("âŒ Sem dados.", ephemeral=True)
    ranking_ord = sorted(stats.items(), key=lambda item: item[1]['vitorias'], reverse=True)[:10]
    embed = discord.Embed(title="ğŸ† RANKING DE ELITE", color=0xF1C40F)
    desc = "```ğŸ† Pos | Jogador          | VIT```\n"
    for i, (uid, d) in enumerate(ranking_ord, 1):
        emoji = "ğŸ¥‡" if i==1 else "ğŸ¥ˆ" if i==2 else "ğŸ¥‰" if i==3 else "ğŸ”¹"
        desc += f"{emoji} `{i:02d}` | <@{uid}> | `{d['vitorias']:02d}`\n"
    embed.description = desc
    await interaction.response.send_message(embed=embed)

@bot.tree.command(name="win", description="Finalizar aposta (Apenas ADM)")
@app_commands.checks.has_role("ADM")
async def win(interaction: discord.Interaction, jogador1: discord.Member, jogador2: discord.Member, valor: str):
    opcoes = [
        discord.SelectOption(label=jogador1.display_name, value=str(jogador1.id), emoji="ğŸ‘¤"),
        discord.SelectOption(label=jogador2.display_name, value=str(jogador2.id), emoji="ğŸ‘¤")
    ]
    view = ViewFinalizarWin(jogador1, jogador2, valor)
    view.select_ganhador.options = opcoes
    view.select_perdedor.options = opcoes
    embed = discord.Embed(title="âš™ï¸ PAINEL DE CONTROLE", description="Selecione os resultados abaixo.", color=0x95A5A6)
    await interaction.response.send_message(embed=embed, view=view)

@bot.tree.command(name="atualizar_filas", description="Gerar painÃ©is de fila")
@app_commands.checks.has_permissions(administrator=True)
async def atualizar_filas(interaction: discord.Interaction):
    await interaction.response.send_message("ğŸ”„ Gerando painÃ©is...", ephemeral=True)
    canais = [c for c in interaction.guild.text_channels if "fila" in c.name.lower()]
    for canal in canais:
        await canal.purge(limit=50)
        for v in valores_lista:
            embed = discord.Embed(title="âš”ï¸ DISPUTA APOSTADA", color=0xE67E22)
            embed.add_field(name="ğŸ’° Valor", value=f"```R$ {v},00```", inline=True)
            embed.set_footer(text="Clique no botÃ£o para entrar")
            await canal.send(embed=embed, view=ViewFilaJogadores(v))

@bot.tree.command(name="central")
async def central(interaction: discord.Interaction):
    await interaction.response.send_message(embed=discord.Embed(title="ğŸ›¡ï¸ CENTRAL", color=0x2f3136), view=ViewCentral())

# --- BOOT E SYNC ---
@bot.event
async def on_ready():
    bot.add_view(ViewCentral())
    print(f"ğŸš€ {bot.user.name} ONLINE!")

@bot.command()
async def sync(ctx):
    fmt = await bot.tree.sync()
    await ctx.send(f"âœ… **{len(fmt)}** comandos sincronizados!")

keep_alive()
bot.run(os.environ['TOKEN'])
